<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Jack Miller (jack.miller@physics.org)">
    <meta name="description" content="A physics-based egg timer that solves the thermal diffusion equation for perfectly cooked eggs">
    <meta name="theme-color" content="#667eea">
    <title>ü•ö Physics-Filled Egg Timer</title>

    <!-- PWA Configuration -->
    <link rel="canonical" href="https://neutralkaon.github.io/Eggtimer/" />
    <link rel="manifest" href="/Eggtimer/manifest.webmanifest">
    <link rel="icon" type="image/png" href="/Eggtimer/img/icon.png">

    <!-- MathJax for equations -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax loaded and ready');
                    });
                }
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        @font-face {
            font-family: 'PixelFont';
            src: local('Courier New'), local('monospace');
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated pixel clouds */
        .cloud {
            position: absolute;
            width: 120px;
            height: 40px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 100px;
            opacity: 0.8;
            animation: float 20s infinite linear;
            box-shadow: 
                0 0 0 2px #fff,
                0 0 0 4px rgba(255,255,255,0.3);
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 100px;
        }

        .cloud::before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }

        .cloud::after {
            width: 60px;
            height: 40px;
            top: -20px;
            right: 15px;
        }

        .cloud:nth-child(1) { top: 10%; animation-duration: 25s; }
        .cloud:nth-child(2) { top: 30%; animation-duration: 30s; animation-delay: -10s; }
        .cloud:nth-child(3) { top: 50%; animation-duration: 35s; animation-delay: -20s; }

        @keyframes float {
            from { transform: translateX(-200px); }
            to { transform: translateX(calc(100vw + 200px)); }
        }

        .container {
            background: #2A2A40;
            border: 4px solid #1A1A2E;
            box-shadow: 
                0 0 0 4px #FF4667,
                0 0 0 8px #1A1A2E,
                0 20px 40px rgba(0,0,0,0.5);
            padding: 30px;
            max-width: 900px;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        h1 {
            color: #FFE66D;
            font-size: 42px;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 
                2px 2px 0 #FF4667,
                4px 4px 0 #1A1A2E,
                4px 4px 20px rgba(255,70,103,0.5);
            letter-spacing: 2px;
            animation: pulse 2s ease-in-out infinite;
            font-weight: bold;
        }

        .subtitle {
            text-align: center;
            color: #A8E6CF;
            font-size: 18px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 0 #000;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .egg-mascot {
            width: 80px;
            height: 100px;
            margin: 0 auto 20px;
            position: relative;
            animation: wobble 3s ease-in-out infinite;
        }

        @keyframes wobble {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        .egg-body {
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5DEB3 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
            box-shadow: 
                inset -10px -10px 20px rgba(0,0,0,0.1),
                inset 10px 10px 20px rgba(255,255,255,0.8),
                0 10px 20px rgba(0,0,0,0.3);
        }

        .egg-face {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 40px;
        }

        .eye {
            width: 8px;
            height: 12px;
            background: #000;
            border-radius: 50%;
            position: absolute;
            top: 0;
            animation: blink 4s infinite;
        }

        .eye.left { left: 15px; }
        .eye.right { right: 15px; }

        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        .mouth {
            width: 16px;
            height: 8px;
            border: 3px solid #000;
            border-top: none;
            border-radius: 0 0 50% 50%;
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .blush {
            width: 16px;
            height: 8px;
            background: rgba(255, 182, 193, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 15px;
        }

        .blush.left { left: 5px; }
        .blush.right { right: 5px; }

        .input-group {
            margin-bottom: 20px;
            background: #1A1A2E;
            padding: 15px;
            border: 2px solid #FF4667;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }

        label {
            display: block;
            color: #A8E6CF;
            font-size: 18px;
            margin-bottom: 8px;
            text-shadow: 1px 1px 0 #000;
            font-weight: bold;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            background: #0F0F1E;
            color: #FFE66D;
            border: 2px solid #A8E6CF;
            outline: none;
            transition: all 0.3s;
        }

        input[type="number"]:focus,
        select:focus {
            border-color: #FFE66D;
            box-shadow: 0 0 10px rgba(255, 230, 109, 0.5);
        }

        .button-container {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        button {
            flex: 1;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 22px;
            background: linear-gradient(135deg, #FF4667 0%, #FF8C94 100%);
            color: #FFF;
            border: 3px solid #1A1A2E;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 
                0 4px 0 #8B0020,
                0 6px 10px rgba(0,0,0,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(2px);
            box-shadow: 
                0 2px 0 #8B0020,
                0 4px 8px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(4px);
            box-shadow: 
                0 0 0 #8B0020,
                0 2px 4px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timer-display {
            background: #0F0F1E;
            border: 3px solid #A8E6CF;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.5);
        }

        .timer-text {
            font-size: 56px;
            color: #FFE66D;
            text-shadow: 
                0 0 10px rgba(255, 230, 109, 0.8),
                2px 2px 0 #FF4667;
            letter-spacing: 4px;
            font-weight: bold;
        }

        .status {
            color: #A8E6CF;
            font-size: 22px;
            margin-top: 10px;
        }

        #temperatureChart {
            background: #0F0F1E;
            border: 3px solid #A8E6CF;
            margin: 20px 0;
            image-rendering: auto;
        }

        .info-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #A8E6CF 0%, #7FCDBB 100%);
            border: 3px solid #1A1A2E;
            border-radius: 50%;
            font-size: 32px;
            color: #1A1A2E;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 
                0 4px 0 #2F4F4F,
                0 6px 10px rgba(0,0,0,0.3);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .info-button:hover {
            transform: scale(1.1) rotate(15deg);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #2A2A40;
            border: 4px solid #FF4667;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 70, 103, 0.5);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 32px;
            color: #FF4667;
            cursor: pointer;
            transition: transform 0.3s;
            font-weight: bold;
        }

        .modal-close:hover {
            transform: rotate(90deg);
        }

        .modal h2 {
            color: #FFE66D;
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #FF4667;
        }

        .modal h3 {
            color: #FFE66D;
            margin: 20px 0 10px;
            font-size: 24px;
        }

        .modal-content p {
            color: #A8E6CF;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .modal-content ul {
            color: #A8E6CF;
            font-size: 18px;
            margin-left: 20px;
        }

        .equation {
            background: #0F0F1E;
            border: 2px solid #A8E6CF;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            color: #FFE66D;
            font-size: 16px;
            overflow-x: auto;
        }

        .sparkle {
            position: absolute;
            animation: sparkle 2s linear infinite;
            pointer-events: none;
        }

        @keyframes sparkle {
            0% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
            }
        }

        .results {
            background: #0F0F1E;
            border: 2px solid #FFE66D;
            padding: 15px;
            margin: 20px 0;
            color: #A8E6CF;
            font-size: 18px;
        }

        .results h3 {
            color: #FFE66D;
            margin-bottom: 10px;
            font-size: 22px;
        }

        .footer {
            text-align: center;
            color: #FFB6C1;
            font-size: 14px;
            margin-top: 20px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="cloud"></div>
    <div class="cloud"></div>
    <div class="cloud"></div>

    <div class="container">
        <h1>ü•ö PHYSICS-FILLED EGG TIMER ü•ö</h1>
        <div class="subtitle">
            Solves the Thermal Diffusion Equation for perfect eggs!<br>
            <span id="equation">\(\frac{\partial T}{\partial t} = \frac{\kappa}{C\rho} \frac{1}{r^2} \frac{\partial}{\partial r}\left(r^2 \frac{\partial T}{\partial r}\right)\)</span>
        </div>
        
        <div class="egg-mascot">
            <div class="egg-body">
                <div class="egg-face">
                    <div class="eye left"></div>
                    <div class="eye right"></div>
                    <div class="mouth"></div>
                    <div class="blush left"></div>
                    <div class="blush right"></div>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label for="altitude">üèîÔ∏è Altitude (metres above sea level):</label>
            <input type="number" id="altitude" value="100" min="0" max="9000" step="10">
        </div>

        <div class="input-group">
            <label for="mass">‚öñÔ∏è Egg Mass (grams):</label>
            <input type="number" id="mass" value="63" min="30" max="100" step="1">
            <select id="eggSize" style="margin-top: 10px;">
                <option value="">Custom Size</option>
                <option value="47">EU Size S (<53g)</option>
                <option value="58" selected>EU Size M (53-63g)</option>
                <option value="68">EU Size L (63-73g)</option>
                <option value="75">EU Size XL (>73g)</option>
            </select>
        </div>

        <div class="input-group">
            <label for="startTemp">‚ùÑÔ∏è Starting Temperature (¬∞C):</label>
            <input type="number" id="startTemp" value="4" min="0" max="30" step="1">
        </div>

        <div class="input-group">
            <label for="targetTemp">üéØ Target Centre Temperature:</label>
            <select id="targetTemp">
                <option value="63">63¬∞C - Soft (Runny yolk)</option>
                <option value="65">65¬∞C - Soft-Medium (Jammy)</option>
                <option value="70">70¬∞C - Medium-Soft</option>
                <option value="72" selected>72¬∞C - Medium</option>
                <option value="75">75¬∞C - Medium-Hard</option>
                <option value="80">80¬∞C - Hard (Fully set)</option>
            </select>
        </div>

        <div class="button-container">
            <button id="startBtn" onclick="startTimer()">üöÄ START TIMER</button>
            <button id="pauseBtn" onclick="pauseTimer()" disabled>‚è∏Ô∏è PAUSE</button>
            <button id="stopBtn" onclick="stopTimer()" disabled>‚èπÔ∏è STOP</button>
        </div>

        <div class="timer-display">
            <div class="timer-text" id="timerDisplay">00:00</div>
            <div class="status" id="status">Ready to cook! üç≥</div>
        </div>

        <div class="results" id="results" style="display: none;">
            <h3>üìä Calculation Results:</h3>
            <div id="resultsContent"></div>
        </div>

        <div class="equation" style="margin-top: 20px; text-align: center;">
            <div id="solutionEquation">
                \[T(r,t) = T_{\rm water} + (T_{\rm egg} - T_{\rm water}) \frac{2a}{\pi r} \sum_{n=1}^{\infty} \frac{(-1)^{n-1}}{n} \sin\left(\frac{n\pi r}{a}\right) \exp\left(-\frac{n^2\pi^2 t}{\tau_0}\right)\]
                <br>
                <span style="font-size: 14px; color: #A8E6CF;">where \(\tau_0 = \frac{c\rho a^2}{\kappa}\) is the thermal time constant</span>
            </div>
        </div>

        <canvas id="temperatureChart" width="800" height="400"></canvas>
        
        <div class="footer">
            Made with ‚ù§Ô∏è for Steph<br>
            Created by Jack Miller (jack.miller@physics.org)<br>
            Licensed under <a href="LICENSE" style="color: #FFB6C1;">GNU GPLv3</a>
        </div>
    </div>

    <button class="info-button" onclick="toggleModal()">?</button>

    <div class="modal" id="infoModal">
        <div class="modal-content">
            <span class="modal-close" onclick="toggleModal()">‚úñ</span>
            <h2>üî¨ The Physics of Perfect Eggs</h2>
            
            <p>Welcome to the quantum realm of egg cooking! This app uses the exact solution to the thermal diffusion equation for a spherically symmetric egg, following the derivation by Dr Charles D. H. Williams.</p>

            <h3>The Thermal Diffusion Equation</h3>
            <p>The temperature distribution in the egg follows the spherical heat equation:</p>
            
            <div class="equation">\[\frac{\partial T}{\partial t} = \frac{\kappa}{C\rho} \frac{1}{r^2} \frac{\partial}{\partial r}\left(r^2 \frac{\partial T}{\partial r}\right)\]</div>
            
            <p>Where:</p>
            <ul>
                <li><b>T</b> = temperature (K)</li>
                <li><b>t</b> = time (s)</li>
                <li><b>Œ∫</b> = thermal conductivity (W/(m¬∑K))</li>
                <li><b>C</b> = specific heat capacity (J/(kg¬∑K))</li>
                <li><b>œÅ</b> = density (kg/m¬≥)</li>
                <li><b>r</b> = radial distance from centre (m)</li>
            </ul>

            <h3>The Solution Method</h3>
            <p>Using the substitution \(T(r,t) = T_1 + B(r,t)/r\), we transform this into a 1D diffusion equation:</p>
            
            <div class="equation">\[\frac{\partial B}{\partial t} = D \frac{\partial^2 B}{\partial r^2}\]</div>
            
            <p>where \(D = \kappa/(C\rho)\) is the thermal diffusivity. The boundary conditions are:</p>
            <ul>
                <li>\(B(0,t) = 0\) (finite temperature at centre)</li>
                <li>\(B(R,t) = 0\) (surface at water temperature)</li>
                <li>\(B(r,0) = r(T_0 - T_1)\) (initial condition)</li>
            </ul>

            <h3>Fourier Mode Expansion</h3>
            <p>We expand in sine waves: \(B = \sin(kr) \exp(-Dk^2t)\). The boundary condition \(B(R,t)=0\) requires \(kR = n\pi\), giving:</p>
            
            <div class="equation">\[B(r,t) = \frac{2R}{\pi}(T_1-T_0) \sum_{n=1}^{\infty} \frac{(-1)^n}{n} \sin\left(\frac{n\pi r}{R}\right) \exp\left(-D\left(\frac{n\pi}{R}\right)^2 t\right)\]</div>

            <h3>Temperature at the Centre</h3>
            <p>Taking the limit \(r \to 0\), using \(\lim_{r\to 0} \sin(n\pi r/R)/r = n\pi/R\):</p>
            
            <div class="equation">\[T(0,t) = T_1 + 2(T_1-T_0)\sum_{n=1}^{\infty} (-1)^n \exp\left(-\frac{n^2\pi^2 t}{\tau_0}\right)\]</div>
            
            <p>where the thermal time constant is \(\tau_0 = C\rho R^2/\kappa = R^2/D\).</p>

            <h3>The Williams Formula (Practical)</h3>
            <p>For \(t > 0.1\tau_0\), the first Fourier mode dominates, and solving for when the yolk-white boundary (at \(r=0.69R\)) reaches temperature \(T_{\rm yolk}\) gives:</p>
            
            <div class="equation">\[t_{\rm cooked} = \kappa M^{2/3} \ln\left[0.76 \frac{T_{\rm egg}-T_{\rm water}}{T_{\rm yolk}-T_{\rm water}}\right]\]</div>
            
            <p>where \(\kappa = C\rho^{1/3}/[\pi^2 \kappa (4\pi/3)^{2/3}]\). This is the formula used by this app!</p>

            <h3>Key Physical Insights</h3>
            <p>üîπ Cooking time scales as \(M^{2/3}\) (radius squared), not volume!</p>
            <p>üîπ The egg acts as a low-pass thermal filter - high-frequency modes decay rapidly</p>
            <p>üîπ Temperature approaches equilibrium exponentially with time constant \(\tau_0\)</p>
            <p>üîπ Smaller eggs equilibrate faster (shorter \(\tau_0\))</p>

            <h3>Altitude Effects</h3>
            <p>At higher altitudes, atmospheric pressure decreases, lowering the boiling point of water approximately as:</p>
            
            <div class="equation">\[T_{\rm boil} \approx 100¬∞\text{C} - \frac{h}{300¬∞\text{C/m}}\]</div>
            
            <p>This means eggs cook slower at altitude since the water temperature is lower!</p>

            <h3>Egg Thermal Properties</h3>
            <p>Values from Polley et al. (1980) via Williams:</p>
            <ul>
                <li><b>Yolk:</b> c = 2.7 J/(g¬∑K), Œ∫ = 3.4√ó10‚Åª¬≥ W/(cm¬∑K), œÅ = 1.032 g/cm¬≥ ‚Üí Œ∫_Williams = 31 s¬∑g‚Åª¬≤/¬≥</li>
                <li><b>White:</b> c = 3.7 J/(g¬∑K), Œ∫ = 5.4√ó10‚Åª¬≥ W/(cm¬∑K), œÅ = 1.038 g/cm¬≥ ‚Üí Œ∫_Williams = 27 s¬∑g‚Åª¬≤/¬≥</li>
                <li><b>Average:</b> c ‚âà 3.2 J/(g¬∑K), Œ∫ ‚âà 4.4√ó10‚Åª¬≥ W/(cm¬∑K), œÅ ‚âà 1.035 g/cm¬≥ ‚Üí Œ∫_Williams ‚âà 29 s¬∑g‚Åª¬≤/¬≥</li>
            </ul>
            
            <p>This app uses <b>Œ∫ = 29 s¬∑g‚Åª¬≤/¬≥</b> (average), which targets the yolk-white boundary temperature.</p>

            <h3>References</h3>
            <p>This implementation follows the derivation in:</p>
            <p><i>C.D.H. Williams, "The Science of Boiling an Egg", University of Exeter (1998-2006)</i></p>

            <p style="margin-top: 30px;">Made with ‚ù§Ô∏è and ‚àÇ/‚àÇt by a physics enthusiast!</p>
        </div>
    </div>

    <script>
        // Global variables
        let timerInterval = null;
        let startTime = null;
        let pauseTime = null;
        let elapsedBeforePause = 0;
        let isPaused = false;
        let cookingTime = 0;
        let animationFrame = null;
        let temperatureHistory = [];
        
        // Physical constants from Williams paper (averaged between yolk and white)
        // Yolk: c=2700, Œ∫=0.34, œÅ=1032, Œ∫_williams=31
        // White: c=3700, Œ∫=0.54, œÅ=1038, Œ∫_williams=27
        const SPECIFIC_HEAT = 3200; // J/(kg¬∑K) 
        const THERMAL_CONDUCTIVITY = 0.44; // W/(m¬∑K)
        const EGG_DENSITY = 1035; // kg/m¬≥
        const THERMAL_DIFFUSIVITY = THERMAL_CONDUCTIVITY / (SPECIFIC_HEAT * EGG_DENSITY); // ‚âà 1.33√ó10‚Åª‚Å∑ m¬≤/s
        const KAPPA_WILLIAMS = 29; // s¬∑g‚Åª¬≤/¬≥ (average for yolk-white boundary)

        // Egg size selector
        document.getElementById('eggSize').addEventListener('change', function(e) {
            if (e.target.value) {
                document.getElementById('mass').value = e.target.value;
            }
        });

        // Calculate boiling point at altitude using barometric formula
        function getBoilingPoint(altitude) {
            // More accurate: T_boil decreases ~1¬∞C per 285m
            // But Williams uses simpler ~1¬∞C per 300m
            return 100 - (altitude / 300);
        }

        // Calculate egg radius from mass
        function getEggRadius(mass) {
            // V = M/œÅ, for sphere: V = 4œÄR¬≥/3
            const volume = (mass / 1000) / EGG_DENSITY; // m¬≥
            const radius = Math.pow((3 * volume) / (4 * Math.PI), 1/3);
            return radius;
        }

        // Calculate temperature at centre using full Fourier series solution
        function calculateCentreTemperature(t, Twater, Tegg, radius) {
            // œÑ‚ÇÄ = cœÅa¬≤/Œ∫ = a¬≤/D
            const tau0 = (radius * radius) / THERMAL_DIFFUSIVITY;
            
            let sum = 0;
            // Sum Fourier modes (convergence is rapid for t > 0.1œÑ‚ÇÄ)
            for (let n = 1; n <= 50; n++) {
                const sign = Math.pow(-1, n); // (-1)^n
                const exponent = -(n * n * Math.PI * Math.PI * t) / tau0;
                sum += sign * Math.exp(exponent);
            }
            
            return Twater + 2 * (Tegg - Twater) * sum;
        }

        // Williams formula for cooking time (THE practical formula)
        function calculateCookingTimeWilliams(targetTemp, Twater, Tegg, mass) {
            // Williams formula: t = Œ∫ M^(2/3) ln[0.76(T_egg - T_water)/(T_yolk - T_water)]
            
            // Temperature ratio - the 0.76 comes from evaluating at yolk-white boundary (r=0.69a)
            const tempRatio = 0.76 * Math.abs(Twater - Tegg) / Math.abs(Twater - targetTemp);
            
            if (tempRatio <= 0) {
                console.error('Invalid temperature ratio - target unreachable');
                return 0;
            }
            
            // Williams formula
            const cookingTime = KAPPA_WILLIAMS * Math.pow(mass, 2/3) * Math.log(tempRatio);
            
            console.log('Williams formula calculation:');
            console.log('  Œ∫ = ' + KAPPA_WILLIAMS + ' s¬∑g^(-2/3)');
            console.log('  M = ' + mass + ' g');
            console.log('  M^(2/3) = ' + Math.pow(mass, 2/3).toFixed(2));
            console.log('  Temperature ratio = ' + tempRatio.toFixed(3));
            console.log('  ln(ratio) = ' + Math.log(tempRatio).toFixed(3));
            console.log('  Cooking time = ' + cookingTime.toFixed(1) + ' s = ' + formatTime(Math.round(cookingTime)));
            
            return Math.max(0, Math.round(cookingTime));
        }

        // Start the timer
        function startTimer() {
            if (timerInterval) return;
            
            // Get input values
            const altitude = parseFloat(document.getElementById('altitude').value) || 0;
            const mass = parseFloat(document.getElementById('mass').value) || 63;
            const startTemp = parseFloat(document.getElementById('startTemp').value) || 4;
            const targetTemp = parseFloat(document.getElementById('targetTemp').value) || 72;
            
            // Validate inputs
            if (mass < 30 || mass > 100) {
                alert('Please enter a valid egg mass between 30 and 100 grams');
                return;
            }
            
            if (startTemp < 0 || startTemp > 30) {
                alert('Please enter a starting temperature between 0¬∞C and 30¬∞C');
                return;
            }
            
            // Calculate parameters
            const boilingPoint = getBoilingPoint(altitude);
            const radius = getEggRadius(mass);
            
            // Check if target is achievable
            if (targetTemp >= boilingPoint) {
                alert(`Cannot reach ${targetTemp}¬∞C when water boils at ${boilingPoint.toFixed(1)}¬∞C at this altitude!`);
                return;
            }
            
            if (targetTemp <= startTemp) {
                alert(`Target temperature (${targetTemp}¬∞C) must be higher than starting temperature (${startTemp}¬∞C)!`);
                return;
            }
            
            // Calculate cooking time using Williams formula
            cookingTime = calculateCookingTimeWilliams(targetTemp, boilingPoint, startTemp, mass);
            
            if (cookingTime <= 0) {
                alert('Unable to calculate cooking time. Please check your inputs.');
                return;
            }
            
            // Display results
            const tau0 = (radius * radius) / THERMAL_DIFFUSIVITY;
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = `
                <p>üå°Ô∏è Water boiling point at ${altitude}m: <strong>${boilingPoint.toFixed(1)}¬∞C</strong></p>
                <p>üìè Egg radius: <strong>${(radius * 1000).toFixed(2)}mm</strong></p>
                <p>‚è±Ô∏è Calculated cooking time: <strong>${formatTime(cookingTime)}</strong></p>
                <p>üî• Thermal diffusivity: <strong>${THERMAL_DIFFUSIVITY.toExponential(2)} m¬≤/s</strong></p>
                <p>üìê Thermal time constant œÑ‚ÇÄ: <strong>${tau0.toFixed(1)}s</strong></p>
                <p>üßÆ Williams Œ∫ parameter: <strong>${KAPPA_WILLIAMS} s¬∑g‚Åª¬≤/¬≥</strong></p>
            `;
            
            // Start timer
            startTime = Date.now();
            elapsedBeforePause = 0;
            isPaused = false;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').textContent = 'üî• Cooking in progress...';
            
            // Add sparkles
            createSparkles();
            
            // Update timer display
            timerInterval = setInterval(updateTimer, 100);
            
            // Draw temperature graph
            drawTemperatureGraph(boilingPoint, startTemp, targetTemp, radius, cookingTime);
        }

        // Pause the timer
        function pauseTimer() {
            if (isPaused) {
                // Resume
                isPaused = false;
                startTime = Date.now() - elapsedBeforePause;
                document.getElementById('pauseBtn').innerHTML = '‚è∏Ô∏è PAUSE';
                document.getElementById('status').textContent = 'üî• Cooking in progress...';
                timerInterval = setInterval(updateTimer, 100);
            } else {
                // Pause
                isPaused = true;
                elapsedBeforePause = Date.now() - startTime;
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('pauseBtn').innerHTML = '‚ñ∂Ô∏è RESUME';
                document.getElementById('status').textContent = '‚è∏Ô∏è Paused';
            }
        }

        // Stop the timer
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            isPaused = false;
            elapsedBeforePause = 0;
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').innerHTML = '‚è∏Ô∏è PAUSE';
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').textContent = 'üõë Timer stopped';
            
            // Clear sparkles
            document.querySelectorAll('.sparkle').forEach(s => s.remove());
        }

        // Update timer display
        function updateTimer() {
            if (!startTime || isPaused) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const remaining = Math.max(0, cookingTime - elapsed);
            
            document.getElementById('timerDisplay').textContent = formatTime(remaining);
            
            if (remaining === 0) {
                stopTimer();
                document.getElementById('status').textContent = '‚ú® EGG IS READY! ‚ú®';
                document.getElementById('timerDisplay').textContent = '00:00';
                playCompletionSound();
                celebrate();
            }
            
            // Update graph with current position
            if (window.graphData) {
                updateTemperatureGraph(elapsed);
            }
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Draw temperature graph
        function drawTemperatureGraph(Twater, Tegg, targetTemp, radius, totalTime) {
            const canvas = document.getElementById('temperatureChart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Background
            ctx.fillStyle = '#0F0F1E';
            ctx.fillRect(0, 0, width, height);
            
            // Grid
            ctx.strokeStyle = '#2A2A40';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = (width / 10) * i;
                const y = (height / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Define doneness levels (in ¬∞C at yolk-white boundary)
            const donenessLevels = [
                { temp: 63, label: 'Soft', color: '#FFE66D', alpha: 0.3 },
                { temp: 70, label: 'Medium', color: '#FF8C94', alpha: 0.3 },
                { temp: 80, label: 'Hard', color: '#FF4667', alpha: 0.3 }
            ];
            
            // Calculate full temperature profile - much longer to show equilibration
            const extendedTime = totalTime * 2.5; // Show 2.5x the cooking time
            const numPoints = Math.min(300, Math.max(100, extendedTime / 2));
            const points = [];
            const tempRange = Twater - Tegg;
            
            for (let i = 0; i <= numPoints; i++) {
                const t = (extendedTime / numPoints) * i;
                const temp = calculateCentreTemperature(t, Twater, Tegg, radius);
                points.push({
                    t: t,
                    x: (width / extendedTime) * t,
                    y: height - ((temp - Tegg) / tempRange) * height * 0.85 - height * 0.08,
                    temp: temp
                });
            }
            
            // Draw doneness level zones with subtle shading
            donenessLevels.forEach(level => {
                if (level.temp <= Twater && level.temp >= Tegg) {
                    const y = height - ((level.temp - Tegg) / tempRange) * height * 0.85 - height * 0.08;
                    
                    // Draw subtle horizontal band
                    ctx.fillStyle = level.color;
                    ctx.globalAlpha = level.alpha;
                    ctx.fillRect(0, y - 8, width, 16);
                    ctx.globalAlpha = 1.0;
                    
                    // Draw dashed line
                    ctx.strokeStyle = level.color;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([8, 4]);
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // Label - place on right side
                    ctx.fillStyle = level.color;
                    ctx.font = 'bold 14px Courier New';
                    ctx.fillText(`${level.temp}¬∞C ${level.label}`, width - 140, y - 12);
                }
            });
            
            // Draw full temperature curve
            ctx.strokeStyle = '#FFE66D';
            ctx.lineWidth = 3;
            ctx.shadowColor = 'rgba(255, 230, 109, 0.5)';
            ctx.shadowBlur = 5;
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            // Highlight the cooking time target
            ctx.strokeStyle = '#FF4667';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            const targetY = height - ((targetTemp - Tegg) / tempRange) * height * 0.85 - height * 0.08;
            ctx.beginPath();
            ctx.moveTo(0, targetY);
            ctx.lineTo(width, targetY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw vertical line at cooking time
            const cookTimeX = (width / extendedTime) * totalTime;
            ctx.strokeStyle = '#A8E6CF';
            ctx.lineWidth = 2;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            ctx.moveTo(cookTimeX, 0);
            ctx.lineTo(cookTimeX, height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Mark the intersection point (cooking completion)
            ctx.fillStyle = '#FF4667';
            ctx.strokeStyle = '#FFE66D';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cookTimeX, targetY, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Labels
            ctx.font = 'bold 18px Courier New';
            ctx.fillStyle = '#A8E6CF';
            ctx.fillText('Temperature (¬∞C)', 10, 30);
            ctx.fillText('Time (s)', width - 80, height - 10);
            
            // Target label with background box
            ctx.fillStyle = '#1A1A2E';
            const targetLabel = `Target: ${targetTemp}¬∞C`;
            const targetLabelWidth = ctx.measureText(targetLabel).width + 16;
            const targetLabelY = targetY > 40 ? targetY - 18 : targetY + 30;
            ctx.fillRect(width - targetLabelWidth - 155, targetLabelY - 22, targetLabelWidth, 28);
            ctx.fillStyle = '#FF4667';
            ctx.fillText(targetLabel, width - targetLabelWidth - 150, targetLabelY);
            
            // Y-axis labels
            ctx.font = '16px Courier New';
            ctx.fillStyle = '#A8E6CF';
            ctx.fillText(`${Tegg}¬∞C`, 10, height - 15);
            ctx.fillText(`${Twater.toFixed(0)}¬∞C`, 10, 55);
            
            // X-axis labels
            ctx.fillText('0s', 5, height - 5);
            ctx.fillText(`${Math.round(extendedTime)}s`, width - 70, height - 5);
            
            // Mark cooking time on x-axis
            ctx.fillStyle = '#A8E6CF';
            ctx.font = 'bold 14px Courier New';
            const cookTimeLabelX = cookTimeX - 40 > 0 ? cookTimeX - 40 : cookTimeX + 10;
            ctx.fillText(`${totalTime}s`, cookTimeLabelX, height - 25);
            ctx.fillText('(Done)', cookTimeLabelX, height - 10);
            
            // Store graph data for updates
            window.graphData = {
                points, Twater, Tegg, targetTemp, radius, totalTime, targetY, tempRange, extendedTime, donenessLevels
            };
        }

        // Update temperature graph with current position
        function updateTemperatureGraph(elapsed) {
            if (!window.graphData) return;
            
            const canvas = document.getElementById('temperatureChart');
            const ctx = canvas.getContext('2d');
            const { points, Twater, Tegg, targetTemp, radius, totalTime, targetY, tempRange, extendedTime, donenessLevels } = window.graphData;
            
            // Redraw base graph
            drawTemperatureGraph(Twater, Tegg, targetTemp, radius, totalTime);
            
            // Draw current position
            const currentX = (canvas.width / extendedTime) * elapsed;
            const currentTemp = calculateCentreTemperature(elapsed, Twater, Tegg, radius);
            const currentY = canvas.height - ((currentTemp - Tegg) / tempRange) * canvas.height * 0.85 - canvas.height * 0.08;
            
            // Vertical line at current time
            ctx.strokeStyle = '#00FFAA';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.shadowColor = 'rgba(0, 255, 170, 0.6)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.moveTo(currentX, 0);
            ctx.lineTo(currentX, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.shadowBlur = 0;
            
            // Current temperature dot with glow
            ctx.shadowColor = 'rgba(255, 70, 103, 0.8)';
            ctx.shadowBlur = 15;
            ctx.fillStyle = '#FF4667';
            ctx.beginPath();
            ctx.arc(currentX, currentY, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 5;
            ctx.strokeStyle = '#FFE66D';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            // Current temperature label with background
            ctx.fillStyle = '#1A1A2E';
            const labelText = `Now: ${currentTemp.toFixed(1)}¬∞C`;
            ctx.font = 'bold 18px Courier New';
            const labelWidth = ctx.measureText(labelText).width + 20;
            const labelX = currentX + 20 < canvas.width - labelWidth ? currentX + 20 : currentX - labelWidth - 20;
            const labelY = currentY - 35;
            
            // Draw label box with border
            ctx.fillRect(labelX - 5, labelY - 22, labelWidth, 32);
            ctx.strokeStyle = '#00FFAA';
            ctx.lineWidth = 2;
            ctx.strokeRect(labelX - 5, labelY - 22, labelWidth, 32);
            
            ctx.fillStyle = '#00FFAA';
            ctx.fillText(labelText, labelX, labelY);
        }

        // Toggle modal
        function toggleModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.toggle('active');
            // Retypeset MathJax when modal opens
            if (modal.classList.contains('active') && window.MathJax) {
                setTimeout(() => window.MathJax.typesetPromise(), 100);
            }
        }

        // Create sparkle effects
        function createSparkles() {
            const container = document.querySelector('.container');
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = '‚ú®';
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    sparkle.style.fontSize = (20 + Math.random() * 20) + 'px';
                    sparkle.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 2000);
                }, i * 200);
            }
        }

        // Celebration animation
        function celebrate() {
            const egg = document.querySelector('.egg-mascot');
            egg.style.animation = 'wobble 0.5s ease-in-out infinite';
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => createSparkles(), i * 100);
            }
            
            setTimeout(() => {
                egg.style.animation = 'wobble 3s ease-in-out infinite';
            }, 5000);
        }

        // Play completion sound (using Web Audio API)
        function playCompletionSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create a cheerful, attention-grabbing 8-bit melody
                // Play a ascending scale that repeats 3 times for better audibility
                const notes = [523.25, 587.33, 659.25, 783.99, 880.00]; // C5, D5, E5, G5, A5
                const repeats = 3;

                for (let repeat = 0; repeat < repeats; repeat++) {
                    notes.forEach((freq, i) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'square'; // 8-bit style

                        const startTime = audioContext.currentTime + repeat * 1.0 + i * 0.15;
                        const endTime = startTime + 0.35;

                        // Increased gain from 0.15 to 0.3 for better audibility
                        gainNode.gain.setValueAtTime(0.3, startTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, endTime);

                        oscillator.start(startTime);
                        oscillator.stop(endTime);
                    });
                }

                console.log('Alarm sound playing - egg is ready!');
            } catch (e) {
                console.log('Audio not available:', e);
                // Fallback: try to use alert as a last resort
                alert('ü•ö Your egg is ready! ü•ö');
            }
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !document.getElementById('startBtn').disabled) {
                startTimer();
            } else if (e.key === ' ' && !document.getElementById('pauseBtn').disabled) {
                e.preventDefault();
                pauseTimer();
            } else if (e.key === 'Escape' && !document.getElementById('stopBtn').disabled) {
                stopTimer();
            } else if (e.key === '?') {
                toggleModal();
            }
        });
        
        // Force MathJax to typeset on load
        window.addEventListener('load', () => {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
            }
        });
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if (navigator.serviceWorker) {
            navigator.serviceWorker.register(
                '/Eggtimer/sw.js',
                {scope: '/Eggtimer/'}
            ).then(function(registration) {
                console.log('Service Worker registered with scope:', registration.scope);
            }).catch(function(error) {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>
</body>
</html>
